<!doctype html>
<html>
    <head>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <style>
            html,
            body {
                margin: 0;
                height: 100%;
                overflow: hidden;
            }

            body {
                display: flex;
                flex-direction: column;
            }

            #source {
                width: 100%;
                resize: none;
                flex-grow: 1;
                margin: 0;
                padding: 0;

                font-size: 1.7em;

                font-family: monospace;
            }

            #wide-controls {
                height: 1cm;
                align-items: center;
                justify-content: center;
                display: flex; /* probably not the right way to implement this but it works */
            }

            .wide-button {
                width: 100%;
                height: 1cm;
                margin: 0;
                padding: 0;
                border: 0;
            }

            #diagnostics {
                background-color: #ffe8e8;
                padding: 0.2cm;
                font-family: monospace;
                display: none;
            }
            #wide-controls > label {
                margin-left: 0.2cm;
            }
            #wide-controls > input:not(:first-child) {
                margin-left: 0.7cm;
            }

            #menu {
                position: fixed;
                width: 100%;
                height: 100%;
                background-color: rgb(0 0 0 / 20%);
                backdrop-filter: blur(5px);
            }

            #menu > div {
                position: fixed;
                top: 10%;
                left: 10%;

                background-color: white;
                border: 1px black solid;

                width: calc(80% - 40px);
                height: calc(80% - 40px);
                padding: 20px;
            }

            #menu button {
                width: 100%;
                height: 1.5cm;
            }

            @media only screen and (min-width: 1200px) {
                .if-narrow {
                    display: none;
                }
            }
            @media only screen and (max-width: 1199px) {
                #wide-controls {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <textarea
            id="source"
            placeholder="Write something, eg. $ e^(i pi) + 1 = 0 $"
            spellcheck="false"
        ></textarea>
        <div id="diagnostics">Diagnostics go here</div>
        <div id="wide-controls">
            <input type="checkbox" id="autosize" checked />
            <label for="autosize">Set width=height=auto</label>
            <input type="checkbox" id="transparent" />
            <label for="transparent">Make transparent</label>
            <input type="number" value="3.0" id="px_per_pt" />
            <label for="px_per_pt">Pixels per point</label>
        </div>
        <button class="wide-button if-narrow" id="open-settings">
            Settings
        </button>
        <div id="menu" hidden>
            <div>
                <h1>Advanced</h1>
                <hr />

                <p>
                    <input type="checkbox" id="autosize1" checked />
                    <label for="autosize1">Set width=height=auto</label>
                </p>

                <p>
                    <input type="checkbox" id="transparent1" />
                    <label for="transparent1">Make transparent</label><br />
                </p>

                <p>
                    <input type="number" value="3.0" id="px_per_pt1" />
                    <label for="px_per_pt1">Pixels per point</label><br />
                </p>

                <p>
                    <button id="close-settings">Close</button>
                </p>
            </div>
        </div>
        <button class="wide-button" id="compile" disabled>
            Loading WASM...
        </button>

        <script type="module">
            import init, { setup, compile } from "./pkg/typst_renderer.js";

            let button = document.querySelector("#compile");
            let textarea = document.querySelector("#source");
            let diagnostics = document.querySelector("#diagnostics");
            let autosize = document.querySelector("#autosize");
            let transparent = document.querySelector("#transparent");
            let px_per_pt = document.querySelector("#px_per_pt");

            let open_settings = document.querySelector("#open-settings");
            let close_settings = document.querySelector("#close-settings");
            let menu = document.querySelector("#menu");

            // In case of reload
            button.disabled = true;

            async function main() {
                await init();

                button.innerText = "Initialising ...";

                let ctx = setup();

                window.compile = compile;
                window.ctx = ctx;

                button.innerText = "Compile (Ctrl+Enter)";
                button.disabled = false;

                function run() {
                    let output = compile(
                        ctx,
                        textarea.value,
                        px_per_pt.value,
                        autosize.checked,
                        transparent.checked,
                    );

                    if (output === undefined) {
                        console.log("A fatal error occured");
                        return;
                    }

                    if (output.output === undefined) {
                        // Compilation error
                        console.log(output.diagnostics);

                        let diag_text = "";
                        for (let diag of output.diagnostics) {
                            if (diag.severity === 1) {
                                diag_text += `Error at ${diag.range.start}..${diag.range.end}: ${diag.message}\n`;
                            }
                        }

                        diagnostics.innerText = diag_text;
                        diagnostics.style.display = "block";
                        return;
                    }

                    diagnostics.style.display = "none";

                    let blob = new Blob([output.output], { type: "image/png" });
                    let url = URL.createObjectURL(blob);
                    window.location = url;
                    // img.src = url;
                }

                button.addEventListener("click", run);
                textarea.addEventListener("keydown", (e) => {
                    if (e.ctrlKey && e.keyCode === 13) run();
                });
            }

            main();

            open_settings.addEventListener("click", () => {
                menu.hidden = false;
            });
            close_settings.addEventListener("click", () => {
                menu.hidden = true;
            });

            function sync(name) {
                let normal = document.getElementById(name);
                let other = document.getElementById(name + "1");

                normal.addEventListener("input", () => {
                    other.checked = normal.checked;
                    other.value = normal.value;
                });
                other.addEventListener("input", () => {
                    normal.checked = other.checked;
                    normal.value = other.value;
                });
            }

            sync("autosize");
            sync("transparent");
            sync("px_per_pt");
        </script>
    </body>
</html>
